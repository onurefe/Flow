/* -*- C -*- */

#include "demodulation.h"

int16_t SineTable[] = {
0x0, 		0x81, 		0x102, 		0x183, 		0x203, 		0x284, 		0x304, 		0x385, 		0x406, 	
0x486, 		0x507, 		0x587, 		0x608, 		0x689, 		0x709, 		0x78a, 		0x80a, 	
0x88a, 		0x90b, 		0x98b, 		0xa0b, 		0xa8c, 		0xb0c, 		0xb8c, 		0xc0c, 	
0xc8c, 		0xd0c, 		0xd8c, 		0xe0c, 		0xe8c, 		0xf0c, 		0xf8c, 		0x100b, 	
0x108b, 	0x110a, 	0x118a, 	0x1209, 	0x1289, 	0x1308, 	0x1387, 	0x1406, 	
0x1485, 	0x1504, 	0x1583, 	0x1602, 	0x1681, 	0x16ff, 	0x177e, 	0x17fc, 	
0x187b, 	0x18f9, 	0x1977, 	0x19f5, 	0x1a73, 	0x1af1, 	0x1b6f, 	0x1bec, 	
0x1c6a, 	0x1ce7, 	0x1d65, 	0x1de2, 	0x1e5f, 	0x1edc, 	0x1f59, 	0x1fd5, 	
0x2052, 	0x20ce, 	0x214b, 	0x21c7, 	0x2243, 	0x22bf, 	0x233b, 	0x23b6, 	
0x2432, 	0x24ad, 	0x2528, 	0x25a3, 	0x261e, 	0x2699, 	0x2714, 	0x278e, 	
0x2808, 	0x2883, 	0x28fc, 	0x2976, 	0x29f0, 	0x2a69, 	0x2ae3, 	0x2b5c, 	
0x2bd5, 	0x2c4e, 	0x2cc6, 	0x2d3f, 	0x2db7, 	0x2e2f, 	0x2ea7, 	0x2f1f, 	
0x2f96, 	0x300e, 	0x3085, 	0x30fc, 	0x3173, 	0x31e9, 	0x3260, 	0x32d6, 	
0x334c, 	0x33c2, 	0x3437, 	0x34ad, 	0x3522, 	0x3597, 	0x360b, 	0x3680, 	
0x36f4, 	0x3768, 	0x37dc, 	0x3850, 	0x38c3, 	0x3937, 	0x39aa, 	0x3a1c, 	
0x3a8f, 	0x3b01, 	0x3b73, 	0x3be5, 	0x3c57, 	0x3cc8, 	0x3d39, 	0x3daa, 	
0x3e1b, 	0x3e8b, 	0x3efb, 	0x3f6b, 	0x3fdb, 	0x404a, 	0x40b9, 	0x4128, 	
0x4197, 	0x4205, 	0x4273, 	0x42e1, 	0x434f, 	0x43bc, 	0x4429, 	0x4496, 	
0x4502, 	0x456f, 	0x45db, 	0x4646, 	0x46b2, 	0x471d, 	0x4788, 	0x47f2, 	
0x485d, 	0x48c7, 	0x4930, 	0x499a, 	0x4a03, 	0x4a6c, 	0x4ad4, 	0x4b3c, 	
0x4ba4, 	0x4c0c, 	0x4c73, 	0x4cda, 	0x4d41, 	0x4da8, 	0x4e0e, 	0x4e74, 	
0x4ed9, 	0x4f3e, 	0x4fa3, 	0x5008, 	0x506c, 	0x50d0, 	0x5134, 	0x5197, 	
0x51fa, 	0x525d, 	0x52bf, 	0x5321, 	0x5383, 	0x53e4, 	0x5445, 	0x54a6, 	
0x5506, 	0x5566, 	0x55c6, 	0x5625, 	0x5684, 	0x56e3, 	0x5741, 	0x579f, 	
0x57fd, 	0x585a, 	0x58b7, 	0x5913, 	0x5970, 	0x59cc, 	0x5a27, 	0x5a82, 	
0x5add, 	0x5b38, 	0x5b92, 	0x5beb, 	0x5c45, 	0x5c9e, 	0x5cf6, 	0x5d4f, 	
0x5da7, 	0x5dfe, 	0x5e55, 	0x5eac, 	0x5f02, 	0x5f58, 	0x5fae, 	0x6003, 	
0x6058, 	0x60ad, 	0x6101, 	0x6155, 	0x61a8, 	0x61fb, 	0x624e, 	0x62a0, 	
0x62f2, 	0x6343, 	0x6394, 	0x63e5, 	0x6435, 	0x6485, 	0x64d4, 	0x6524, 	
0x6572, 	0x65c0, 	0x660e, 	0x665c, 	0x66a9, 	0x66f5, 	0x6742, 	0x678e, 	
0x67d9, 	0x6824, 	0x686f, 	0x68b9, 	0x6903, 	0x694c, 	0x6995, 	0x69dd, 	
0x6a26, 	0x6a6d, 	0x6ab5, 	0x6afb, 	0x6b42, 	0x6b88, 	0x6bcd, 	0x6c13, 	
0x6c57, 	0x6c9c, 	0x6ce0, 	0x6d23, 	0x6d66, 	0x6da9, 	0x6deb, 	0x6e2c, 	
0x6e6e, 	0x6eaf, 	0x6eef, 	0x6f2f, 	0x6f6e, 	0x6fae, 	0x6fec, 	0x702a, 	
0x7068, 	0x70a6, 	0x70e2, 	0x711f, 	0x715b, 	0x7196, 	0x71d1, 	0x720c, 	
0x7246, 	0x7280, 	0x72b9, 	0x72f2, 	0x732b, 	0x7362, 	0x739a, 	0x73d1, 	
0x7408, 	0x743e, 	0x7473, 	0x74a8, 	0x74dd, 	0x7511, 	0x7545, 	0x7579, 	
0x75ab, 	0x75de, 	0x7610, 	0x7641, 	0x7672, 	0x76a3, 	0x76d3, 	0x7702, 	
0x7732, 	0x7760, 	0x778e, 	0x77bc, 	0x77e9, 	0x7816, 	0x7843, 	0x786e, 	
0x789a, 	0x78c5, 	0x78ef, 	0x7919, 	0x7942, 	0x796b, 	0x7994, 	0x79bc, 	
0x79e3, 	0x7a0a, 	0x7a31, 	0x7a57, 	0x7a7d, 	0x7aa2, 	0x7ac6, 	0x7aea, 	
0x7b0e, 	0x7b31, 	0x7b54, 	0x7b76, 	0x7b98, 	0x7bb9, 	0x7bda, 	0x7bfa, 	
0x7c1a, 	0x7c39, 	0x7c58, 	0x7c76, 	0x7c94, 	0x7cb1, 	0x7cce, 	0x7cea, 	
0x7d06, 	0x7d22, 	0x7d3c, 	0x7d57, 	0x7d71, 	0x7d8a, 	0x7da3, 	0x7dbb, 	
0x7dd3, 	0x7dea, 	0x7e01, 	0x7e18, 	0x7e2d, 	0x7e43, 	0x7e58, 	0x7e6c, 	
0x7e80, 	0x7e93, 	0x7ea6, 	0x7eb9, 	0x7eca, 	0x7edc, 	0x7eed, 	0x7efd, 	
0x7f0d, 	0x7f1c, 	0x7f2b, 	0x7f3a, 	0x7f47, 	0x7f55, 	0x7f62, 	0x7f6e, 	
0x7f7a, 	0x7f85, 	0x7f90, 	0x7f9a, 	0x7fa4, 	0x7fae, 	0x7fb7, 	0x7fbf, 	
0x7fc7, 	0x7fce, 	0x7fd5, 	0x7fdb, 	0x7fe1, 	0x7fe6, 	0x7feb, 	0x7fef, 	
0x7ff3, 	0x7ff6, 	0x7ff9, 	0x7ffb, 	0x7ffd, 	0x7ffe, 	0x7fff};

void getHalfHarmonics(uint16_t *adcBuffer, Bool_t secondHalf, float *m0Real, float *m0Img, float *m1Real, float *m1Img)
{
   	qint0_31_t qm0_real = 0;
    qint0_31_t qm0_img = 0;
    qint0_31_t qm1_real = 0;
    qint0_31_t qm1_img = 0;
    
  	uint16_t quadoffset = SAMPLES_PER_MEASUREMENT >> 2;
    qint0_15_t sine, cosine;
    uint16_t sidx = DEAD_SAMPLES;
    uint16_t *adcbuff = adcBuffer[secondHalf * SAMPLES_PER_MEASUREMENT];
    
    if (!secondHalf)
    {
    	while (sidx < quadoffset)
    	{
    		sine = SineTable[sidx];
    		cosine = SineTable[quadoffset - (sidx + 1)];
    	
    		qm0_real += adcbuff[sidx];
			qm0_real += adcbuff[sidx + quadoffset];
		
			qm1_real += (adcbuff[sidx] * cosine) >> 6;
	    	qm1_img -= (adcbuff[sidx] * sine) >> 6;
	    
	   		qm1_real -= (adcbuff[sidx + quadoffset] * sine) >> 6;
	    	qm1_img -= (adcbuff[sidx + quadoffset] * cosine) >> 6;
	   	
	   		sidx++;
	    
		    qm0_img -= adcbuff[sidx];
			qm0_img -= adcbuff[sidx + quadoffset];
			 
			qm1_real -= (adcbuff[sidx] * sine) >> 6;
			qm1_img -= (adcbuff[sidx] * cosine) >> 6;
		   
		    qm1_real -= (adcbuff[sidx + quadoffset] * cosine) >> 6;
		   	qm1_img += (adcbuff[sidx + quadoffset] * sine) >> 6;
		    
			sidx++;
	    
		    qm0_real -= adcbuff[sidx];
			qm0_real -= adcbuff[sidx + quadoffset];
			
			qm1_real -= (adcbuff[sidx] * cosine) >> 6;
		    qm1_img += (adcbuff[sidx] * sine) >> 6;
		    
		   	qm1_real += (adcbuff[sidx + quadoffset] * sine) >> 6;
		    qm1_img += (adcbuff[sidx + quadoffset] * cosine) >> 6;
		   	
		   	sidx++;
	    
		    qm0_img += adcbuff[sidx];
			qm0_img += adcbuff[sidx + quadoffset];
		
			qm1_real += (adcbuff[sidx] * sine) >> 6;	
			qm1_img += (adcbuff[sidx] * cosine) >> 6;
		    
		    qm1_real += (adcbuff[sidx + quadoffset] * cosine) >> 6;
		   	qm1_img -= (adcbuff[sidx + quadoffset] * sine) >> 6;
		    
		   	sidx++;
    	}
    }
    else
    {
    	while (sidx < quadoffset)
	    {
	    	sine = SineTable[sidx];
	    	cosine = SineTable[quadoffset - (sidx + 1)];
	    	
	    	qm0_real += adcbuff[sidx];
			qm0_real += adcbuff[sidx + quadoffset];
			
			qm1_real -= (adcbuff[sidx] * cosine) >> 6;
		    qm1_img += (adcbuff[sidx] * sine) >> 6;
		    
		   	qm1_real += (adcbuff[sidx + quadoffset] * sine) >> 6;
		    qm1_img += (adcbuff[sidx + quadofset] * cosine) >> 6;
		   	
		   	sidx++;
		    
		    qm0_img -= adcbuff[sidx];
			qm0_img -= adcbuff[sidx + quadoffset];
			 
			qm1_real += (adcbuff[sidx] * sine) >> 6;
			qm1_img += (adcbuff[sidx] * cosine) >> 6;
		   
		    qm1_real += (adcbuff[sidx + quadoffset] * cosine) >> 6;
		   	qm1_img -= (adcbuff[sidx + quadoffset] * sine) >> 6;
		    
		   	sidx++;
		    
		    qm0_real -= adcbuff[sidx];
			qm0_real -= adcbuff[sidx + quadoffset];
			
			qm1_real += (adcbuff[sidx] * cosine) >> 6;
		    qm1_img -= (adcbuff[sidx] * sine) >> 6;
		    
		   	qm1_real -= (adcbuff[sidx + quadoffset] * sine) >> 6;
		    qm1_img -= (adcbuff[sidx + quadoffset] * cosine) >> 6;
		   	
		   	sidx++;
		    
		    qm0_img += adcbuff[sidx];
			qm0_img += adcbuff[sidx + quadoffset];
		
			qm1_real -= (adcbuff[sidx] * sine) >> 6;	
			qm1_img -= (adcbuff[sidx] * cosine) >> 6;
		    
		    qm1_real -= (adcbuff[sidx + quadoffset] * cosine) >> 6;
		   	qm1_img += (adcbuff[sidx + quadoffset] * sine) >> 6;
		        
		    sidx++;
	    }
    }
    
    // Scale m0 components.
    qm0_real = qm0_real << 9;
    qm0_img = qm0_img << 9;
    
    // Set return value.
    *m0Real = qm0_real;
    *m0Img = qm0_img;
    *m1Real = qm1_real;
    *m1Img = qm1_img;
}